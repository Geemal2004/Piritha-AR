<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>University Campus Logo AR</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <!-- AR.js GPS helper for location-based features -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@2.4.1/src/tracking/geolocation/GPS.js"></script>
  <script>
    // Debug: Check if model loads
    AFRAME.registerComponent('model-checker', {
      init: function() {
        this.el.addEventListener('model-loaded', () => {
          console.log('‚úÖ Model loaded successfully!');
        });
        this.el.addEventListener('model-error', (e) => {
          console.error('‚ùå Model loading error:', e);
        });
      }
    });
  </script>
    <script>
      // GPS debug HUD component: shows live coords, accuracy, and status
      AFRAME.registerComponent('gps-debug', {
        schema: {},
        init: function () {
          // create HUD container
          this.hud = document.createElement('div');
          this.hud.id = 'gps-hud';
          Object.assign(this.hud.style, {
            position: 'fixed',
            bottom: '10px',
            left: '10px',
            padding: '8px 12px',
            background: 'rgba(0,0,0,0.6)',
            color: 'white',
            fontSize: '13px',
            zIndex: 9999,
            borderRadius: '6px',
          });
          this.hud.innerHTML = 'GPS: initializing...';
          document.body.appendChild(this.hud);

          // listen for gps-camera events (AR.js gps-camera triggers locationFound)
          window.addEventListener('gps-camera-update-position', (ev) => {
            // custom event used by some gps-camera versions; adapt as fallback
            const lat = ev.detail.position.latitude;
            const lon = ev.detail.position.longitude;
            const acc = ev.detail.position.accuracy;
            this.updateHUD(lat, lon, acc);
          });

          // Poll from arjs GPS if present
          this.gpsInterval = setInterval(() => {
            // attempt to read from gps-camera element
            const cam = document.querySelector('[gps-camera]');
            if (cam && cam.components && cam.components['gps-camera'] && cam.components['gps-camera'].currentCoords) {
              const c = cam.components['gps-camera'].currentCoords;
              if (c && c.latitude && c.longitude) {
                this.updateHUD(c.latitude, c.longitude, c.accuracy || 'n/a');
                return;
              }
            }

            // fallback: use Geolocation API directly
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition((pos) => {
                this.updateHUD(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
              }, (err) => {
                this.hud.innerHTML = 'GPS error: ' + err.message;
              }, {enableHighAccuracy: true, maximumAge: 5000});
            } else {
              this.hud.innerHTML = 'Geolocation not supported';
            }
          }, 1500);
        },
        updateHUD: function(lat, lon, acc) {
          this.hud.innerHTML = `<strong>GPS</strong><br>lat: ${lat.toFixed(6)}<br>lon: ${lon.toFixed(6)}<br>acc: ${acc}`;
          console.log('GPS update:', lat, lon, acc);
        },
        remove: function() {
          clearInterval(this.gpsInterval);
          if (this.hud && this.hud.parentNode) this.hud.parentNode.removeChild(this.hud);
        }
      });
    </script>
  <script>
    // Place model at FIRST GPS location only (persists when user walks away)
    AFRAME.registerComponent('place-at-first-location', {
      init: function() {
        this.placed = false;
        this.placedLat = null;
        this.placedLon = null;
        
        // Listen for refresh event
        window.addEventListener('refresh-model-location', () => {
          this.refreshLocation();
        });
        
        this.checkInterval = setInterval(() => {
          if (this.placed) return;
          
          const camera = document.querySelector('[gps-camera]');
          if (camera && camera.components && camera.components['gps-camera']) {
            const coords = camera.components['gps-camera'].currentCoords;
            if (coords && coords.latitude && coords.longitude) {
              this.placeModel(coords.latitude, coords.longitude);
            }
          }
        }, 500);
      },
      
      placeModel: function(userLat, userLon) {
        // Place model at current user location
        this.placedLat = userLat;
        this.placedLon = userLon;
        
        this.el.setAttribute('gps-entity-place', {
          latitude: this.placedLat,
          longitude: this.placedLon
        });
        
        console.log(`üìç Model placed at: ${this.placedLat.toFixed(6)}, ${this.placedLon.toFixed(6)}`);
        this.placed = true;
        
        // Update status message
        const statusDiv = document.getElementById('status-message');
        if (statusDiv) {
          statusDiv.innerHTML = '‚úÖ Logo placed! Walk away to view it from distance.';
        }
      },
      
      refreshLocation: function() {
        console.log('üîÑ Refreshing model location...');
        this.placed = false;
        
        const camera = document.querySelector('[gps-camera]');
        if (camera && camera.components && camera.components['gps-camera']) {
          const coords = camera.components['gps-camera'].currentCoords;
          if (coords && coords.latitude && coords.longitude) {
            this.placeModel(coords.latitude, coords.longitude);
          }
        }
      },
      
      remove: function() {
        clearInterval(this.checkInterval);
      }
    });
  </script>
  <script>
    // Log when GPS entities are placed
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ AR App loaded. Waiting for GPS...');
      
      setTimeout(() => {
        const gpsEntities = document.querySelectorAll('[gps-entity-place]');
        console.log('üìç Found GPS entities:', gpsEntities.length);
        gpsEntities.forEach((entity, i) => {
          const coords = entity.getAttribute('gps-entity-place');
          console.log(`Entity ${i}:`, coords);
        });
      }, 2000);
    });
  </script>
</head>
<body style="margin: 0; overflow: hidden;">
  
  <!-- GPS-based AR Scene -->
  <a-scene 
    embedded 
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true;">
    
    <!-- Add lighting for outdoor GPS mode -->
    <a-light type="ambient" color="#FFF" intensity="1"></a-light>
    <a-light type="directional" color="#FFF" intensity="0.8" position="1 1 1"></a-light>
    <a-light type="hemisphere" color="#FFF" groundColor="#888" intensity="0.5"></a-light>
    
    <!-- 3D Logo Model - placed at FIXED TEST LOCATION (Ground) -->
    <!-- Test coordinates: 6.821923, 80.040653 -->
    <!-- Altitude: Adjust the position Y value to set height above ground -->
    <a-entity gps-entity-place="latitude: 6.821923; longitude: 80.040653;">
      
      <!-- DEBUG: Large colored spheres at different heights to verify GPS placement -->
      <a-sphere position="0 0 0" radius="2" color="#FF0000" material="opacity: 0.8; transparent: true;"></a-sphere>
      <a-sphere position="0 3 0" radius="1.5" color="#00FF00" material="opacity: 0.8; transparent: true;"></a-sphere>
      <a-sphere position="0 6 0" radius="1" color="#0000FF" material="opacity: 0.8; transparent: true;"></a-sphere>
      
      <!-- Your 3D Model - STATIONARY, larger scale -->
      <!-- position="0 Y 0" where Y is height in meters above ground level -->
      <a-entity 
        gltf-model="model.glb" 
        position="0 5 0" 
        scale="5 5 5"
        rotation="0 0 0"
        material="shader: standard; metalness: 0.2; roughness: 0.7;">
      </a-entity>
      
    </a-entity>
    
    <!-- Marker-based fallback for indoor testing -->
    <a-marker preset="hiro">
      <!-- Lighting for the 3D model -->
      <a-light type="ambient" intensity="0.8"></a-light>
      <a-light type="directional" intensity="0.5" position="1 1 1"></a-light>
      
      <a-entity 
        gltf-model="model.glb" 
        position="0 0 0" 
        scale="1 1 1"
        rotation="0 0 0"
        model-checker
        animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear;">
      </a-entity>
      
      <!-- Backup test box: Change visible to "true" to test if marker detection works -->
      <a-box position="0 0.5 0" material="color: red;" scale="0.3 0.3 0.3" visible="true"></a-box>
    </a-marker>
    
    <a-camera gps-camera="minDistance: 1; maxDistance: 200; simulateLatitude: 6.821923; simulateLongitude: 80.040653;" rotation-reader look-controls-enabled="false" arjs-look-controls="smoothingFactor: 0.1"></a-camera>
    
  <!-- GPS debug overlay (hidden when coordinates unavailable) -->
  <a-entity id="gps-debug-hud" gps-debug></a-entity>
    
  </a-scene>
  
  <!-- Instructions overlay -->
  <div style="position: fixed; top: 10px; width: 100%; text-align: center; z-index: 1; color: white; background: rgba(0,0,0,0.5); padding: 10px;">
    <p id="status-message" style="margin: 5px;">üìç Logo at: 6.821923, 80.040653</p>
    <p style="margin: 5px; font-size: 13px; color: #ffff00;">üî¥üü¢üîµ Look for COLORED SPHERES</p>
    <p style="margin: 5px; font-size: 12px;">Red (ground) ‚Üí Green (3m) ‚Üí Blue (6m)</p>
    <p style="margin: 5px; font-size: 11px; opacity: 0.8;">Distance shown below ‚Üì</p>
  </div>
  
  <!-- Distance & Direction Info -->
  <div id="distance-info" style="position: fixed; bottom: 70px; left: 10px; z-index: 9999; 
       padding: 10px 15px; background: rgba(0,100,200,0.7); color: white; 
       border-radius: 8px; font-size: 14px; font-family: Arial, sans-serif; display: none;">
    <strong>To Logo:</strong><br>
    <span id="distance-text">Calculating...</span>
  </div>

  <script>
    // Calculate and display distance to model
    setInterval(() => {
      const cam = document.querySelector('[gps-camera]');
      if (cam && cam.components && cam.components['gps-camera']) {
        const userCoords = cam.components['gps-camera'].currentCoords;
        if (userCoords && userCoords.latitude && userCoords.longitude) {
          const targetLat = 6.821923;
          const targetLon = 80.040653;
          
          // Calculate distance using Haversine formula
          const R = 6371000; // Earth's radius in meters
          const lat1 = userCoords.latitude * Math.PI / 180;
          const lat2 = targetLat * Math.PI / 180;
          const deltaLat = (targetLat - userCoords.latitude) * Math.PI / 180;
          const deltaLon = (targetLon - userCoords.longitude) * Math.PI / 180;
          
          const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          const distance = R * c;
          
          const distInfo = document.getElementById('distance-info');
          const distText = document.getElementById('distance-text');
          if (distInfo && distText) {
            distInfo.style.display = 'block';
            distText.innerHTML = `${distance.toFixed(1)}m away`;
            
            if (distance < 5) {
              distInfo.style.background = 'rgba(0,200,100,0.8)';
              distText.innerHTML += '<br>üéØ Very close!';
            } else if (distance < 20) {
              distInfo.style.background = 'rgba(0,150,200,0.7)';
              distText.innerHTML += '<br>üëÄ Look around';
            } else {
              distInfo.style.background = 'rgba(200,100,0,0.7)';
              distText.innerHTML += '<br>ÔøΩ Walk closer';
            }
          }
        }
      }
    }, 1000);
  </script>
  
</body>
</html>