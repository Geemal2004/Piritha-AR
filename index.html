<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>2025 NSBM AR Experience</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }

    #ar-container {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    #ar-container a-scene,
    #ar-container canvas,
    #ar-container video {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
    }

    video.arjs-video {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      opacity: 0;
      pointer-events: none;
    }

    #instructions {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 24px);
      max-width: 480px;
      text-align: center;
      color: #fff;
      background: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(6px);
      padding: 12px 10px;
      font-size: 14px;
      line-height: 1.4;
      border-radius: 12px;
      z-index: 3;
    }

    #instructions p {
      margin: 4px 0;
    }

    #gps-hud {
      position: absolute;
      bottom: 12px;
      left: 12px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.65);
      color: #fff;
      border-radius: 10px;
      font-size: 12px;
      z-index: 3;
    }

    #capture-btn {
      position: absolute;
      bottom: 22px;
      left: 50%;
      transform: translateX(-50%);
      width: 76px;
      height: 76px;
      background: rgba(255, 255, 255, 0.9);
      border: 4px solid rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      cursor: pointer;
      z-index: 3;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.35);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s ease;
    }

    #capture-btn div {
      width: 62px;
      height: 62px;
      background: #fff;
      border-radius: 50%;
      border: 3px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }

    #ar-container .a-enter-vr {
      bottom: 18px;
      right: 18px;
    }
  </style>
</head>
<body>

<div id="ar-container">

<a-scene embedded
  vr-mode-ui="enabled: false" 
  arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" 
  renderer="antialias: true; alpha: true; preserveDrawingBuffer: true;">
  
  <!-- GPS Camera -->
  <a-camera 
    gps-new-camera="gpsMinDistance: 5; positionMinAccuracy: 50;" 
    rotation-reader>
  </a-camera>
  
  <!-- Your 3D Model at Fixed GPS Location -->
  <a-entity
    gps-new-entity-place="latitude: 6.820290; longitude: 80.039588;"
    gltf-model="model.glb"
    scale="5 5 5"
    position="0 0 0"
    animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear">
  </a-entity>

</a-scene>

<!-- GPS Status HUD -->
<div id="gps-hud">
  GPS: Waiting...
</div>

<!-- Instructions -->
<div id="instructions">
  <p style="margin: 5px;">Target: 6.820290, 80.039588</p>
  <p style="margin: 5px; font-size: 13px; color: #ffff00;">Look for rotating logo</p>
  <p style="margin: 5px; font-size: 12px;">Stand 5-50m away and point camera towards location</p>
</div>

<!-- Capture Photo Button -->
<button id="capture-btn">
  <div>
  </div>
</button>

</div>

<script>
  // Photo capture functionality
  const captureBtn = document.getElementById('capture-btn');
  
  captureBtn.addEventListener('click', function() {
    // Flash effect - scale animation
    captureBtn.style.transform = 'translateX(-50%) scale(0.9)';
    
    // Wait for next frame to ensure scene is rendered
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const scene = document.querySelector('a-scene');
        
        if (!scene || !scene.renderer) {
          alert('Scene not ready. Please try again.');
          captureBtn.style.transform = 'translateX(-50%) scale(1)';
          return;
        }
        
        const canvas = scene.renderer.domElement;
        
        try {
          // Create image from canvas
          const dataURL = canvas.toDataURL('image/png');
          
          // Check if image has content
          if (dataURL === 'data:,') {
            alert('Canvas is empty. Make sure AR is active.');
            captureBtn.style.transform = 'translateX(-50%) scale(1)';
            return;
          }
          
          // Create download link
          const link = document.createElement('a');
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          link.download = `AR-Campus-Logo-${timestamp}.png`;
          link.href = dataURL;
          link.click();
          
          // Success feedback - brief flash
          captureBtn.querySelector('div').style.background = '#4CAF50';
          
          // Reset button
          setTimeout(() => {
            captureBtn.style.transform = 'translateX(-50%) scale(1)';
            captureBtn.querySelector('div').style.background = 'white';
          }, 300);
          
        } catch (error) {
          console.error('Capture error:', error);
          alert('Failed to capture photo: ' + error.message);
          captureBtn.style.transform = 'translateX(-50%) scale(1)';
        }
      });
    });
  });
  
  // GPS position tracking
  const hudEl = document.getElementById('gps-hud');
  const camera = document.querySelector('[gps-new-camera]');
  
  camera.addEventListener('gps-camera-update-position', function(event) {
    const pos = event.detail.position;
    const targetLat = 6.820290;
    const targetLon = 80.039588;
    
    // Calculate distance
    const R = 6371000; // Earth radius in meters
    const lat1 = pos.latitude * Math.PI / 180;
    const lat2 = targetLat * Math.PI / 180;
    const deltaLat = (targetLat - pos.latitude) * Math.PI / 180;
    const deltaLon = (targetLon - pos.longitude) * Math.PI / 180;
    
    const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
              Math.cos(lat1) * Math.cos(lat2) *
              Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    hudEl.innerHTML = `
      <strong>üìç GPS Position</strong><br>
      Lat: ${pos.latitude.toFixed(6)}<br>
      Lon: ${pos.longitude.toFixed(6)}<br>
      Acc: ${pos.accuracy.toFixed(1)}m<br>
      <strong>Distance to Target:</strong><br>
      ${distance.toFixed(1)}m ${distance < 50 ? '‚úÖ' : 'üö∂'}
    `;
    
    console.log('GPS Update:', pos.latitude, pos.longitude, 'Distance:', distance.toFixed(1) + 'm');
  });
  
  // Model loaded check
  window.addEventListener('load', () => {
    const models = document.querySelectorAll('[gltf-model]');
    models.forEach(model => {
      model.addEventListener('model-loaded', () => {
        console.log('‚úÖ 3D Model loaded successfully!');
      });
      model.addEventListener('model-error', (e) => {
        console.error('‚ùå Model loading error:', e);
      });
    });
  });
</script>

</body>
</html>
