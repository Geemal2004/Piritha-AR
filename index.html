<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>2025 NSBM AR Experience</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    :root {
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
    }

    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      background: #020617;
      color: #f8fafc;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    a-scene {
      width: 100vw;
      height: 100vh;
    }

    .hud {
      position: fixed;
      bottom: calc(16px + var(--safe-bottom));
      left: calc(16px + var(--safe-left));
      padding: 12px 16px;
      background: rgba(13, 18, 28, 0.78);
      backdrop-filter: blur(14px);
      border-radius: 14px;
      box-shadow: 0 18px 38px rgba(2, 6, 23, 0.45);
      font-size: 14px;
      line-height: 1.45;
      z-index: 9999;
      max-width: min(90vw, 260px);
    }

    .hud strong {
      display: block;
      font-size: 12px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      color: #8cd7ff;
      margin-bottom: 4px;
    }

    .instructions {
      position: fixed;
      top: calc(16px + var(--safe-top));
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 22px;
      background: rgba(8, 12, 24, 0.78);
      backdrop-filter: blur(16px);
      border-radius: 18px;
      box-shadow: 0 20px 45px rgba(2, 6, 23, 0.45);
      text-align: center;
      z-index: 9999;
      color: #e2e8f0;
      max-width: min(92vw, 360px);
    }

    .instructions p {
      margin: 6px 0;
      font-size: 13px;
    }

    .instructions__title {
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: #bae6fd;
    }

    .instructions__hint {
      color: #facc15;
      font-weight: 500;
    }

    .instructions__distance {
      font-size: 12px;
      color: rgba(226, 232, 240, 0.8);
    }

    .shutter-btn {
      position: fixed;
      bottom: calc(24px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 4px solid rgba(255, 255, 255, 0.4);
      background: rgba(15, 23, 42, 0.52);
      backdrop-filter: blur(12px);
      cursor: pointer;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 140ms ease, border-color 180ms ease, background 200ms ease;
    }

    .shutter-btn__inner {
      width: 66px;
      height: 66px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(234, 236, 240, 0.78));
      border: 2px solid rgba(15, 23, 42, 0.38);
      box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.7), inset 0 -3px 6px rgba(15, 23, 42, 0.28);
      transition: background 220ms ease;
    }

    .shutter-btn.is-capturing {
      transform: translateX(-50%) scale(0.92);
      border-color: rgba(74, 222, 128, 0.85);
    }

    @media (min-width: 768px) {
      .instructions {
        max-width: 420px;
        padding: 16px 28px;
      }

      .instructions p {
        font-size: 14px;
      }

      .hud {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>

<a-scene 
  vr-mode-ui="enabled: false" 
  arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" 
  renderer="antialias: true; alpha: true; preserveDrawingBuffer: true;">
  
  <!-- GPS Camera -->
  <a-camera 
    gps-new-camera="gpsMinDistance: 5; positionMinAccuracy: 50;" 
    rotation-reader>
  </a-camera>
  
  <!-- Your 3D Model at Fixed GPS Location -->
  <a-entity
    gps-new-entity-place="latitude: 6.820290; longitude: 80.039588;"
    gltf-model="model.glb"
    scale="5 5 5"
    position="0 0 0"
    animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear">
  </a-entity>

</a-scene>

<!-- GPS Status HUD -->
<div id="gps-hud" class="hud">
  GPS: Waiting...
</div>

<!-- Instructions -->
<div class="instructions">
  <p class="instructions__title">NSBM AR Marker</p>
  <p class="instructions__hint">Target: 6.820290, 80.039588</p>
  <p class="instructions__distance">Stand 5-50 m away and aim your camera toward the site.</p>
</div>

<!-- Capture Photo Button -->
<button id="capture-btn" class="shutter-btn" aria-label="Capture photo">
  <span class="shutter-btn__inner"></span>
</button>

<script>
  // Photo capture functionality
  const captureBtn = document.getElementById('capture-btn');
  const innerRing = captureBtn ? captureBtn.querySelector('.shutter-btn__inner') : null;

  captureBtn?.addEventListener('click', function() {
    captureBtn.classList.add('is-capturing');

    // Wait for next frame to ensure scene is rendered
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        const scene = document.querySelector('a-scene');

        if (!scene || !scene.renderer) {
          alert('Scene not ready. Please try again.');
          captureBtn.classList.remove('is-capturing');
          return;
        }

        const canvas = scene.renderer.domElement;

        try {
          // Create image from canvas
          const dataURL = canvas.toDataURL('image/png');

          // Check if image has content
          if (dataURL === 'data:,') {
            alert('Canvas is empty. Make sure AR is active.');
            captureBtn.classList.remove('is-capturing');
            return;
          }

          // Create download link
          const link = document.createElement('a');
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          link.download = `AR-Campus-Logo-${timestamp}.png`;
          link.href = dataURL;
          link.click();

          // Success feedback - brief flash
          if (innerRing) {
            innerRing.style.background = '#4CAF50';
          }

          // Reset button
          setTimeout(() => {
            captureBtn.classList.remove('is-capturing');
            if (innerRing) {
              innerRing.style.background = '';
            }
          }, 320);

        } catch (error) {
          console.error('Capture error:', error);
          alert('Failed to capture photo: ' + error.message);
          captureBtn.classList.remove('is-capturing');
          if (innerRing) {
            innerRing.style.background = '';
          }
        }
      });
    });
  });
  
  // GPS position tracking
  const hudEl = document.getElementById('gps-hud');
  const camera = document.querySelector('[gps-new-camera]');
  
  camera.addEventListener('gps-camera-update-position', function(event) {
    const pos = event.detail.position;
    const targetLat = 6.820290;
    const targetLon = 80.039588;
    
    // Calculate distance
    const R = 6371000; // Earth radius in meters
    const lat1 = pos.latitude * Math.PI / 180;
    const lat2 = targetLat * Math.PI / 180;
    const deltaLat = (targetLat - pos.latitude) * Math.PI / 180;
    const deltaLon = (targetLon - pos.longitude) * Math.PI / 180;
    
    const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
              Math.cos(lat1) * Math.cos(lat2) *
              Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c;
    
    hudEl.innerHTML = `
      <strong>üìç GPS Position</strong><br>
      Lat: ${pos.latitude.toFixed(6)}<br>
      Lon: ${pos.longitude.toFixed(6)}<br>
      Acc: ${pos.accuracy.toFixed(1)}m<br>
      <strong>Distance to Target:</strong><br>
      ${distance.toFixed(1)}m ${distance < 50 ? '‚úÖ' : 'üö∂'}
    `;
    
    console.log('GPS Update:', pos.latitude, pos.longitude, 'Distance:', distance.toFixed(1) + 'm');
  });
  
  // Model loaded check
  window.addEventListener('load', () => {
    const models = document.querySelectorAll('[gltf-model]');
    models.forEach(model => {
      model.addEventListener('model-loaded', () => {
        console.log('‚úÖ 3D Model loaded successfully!');
      });
      model.addEventListener('model-error', (e) => {
        console.error('‚ùå Model loading error:', e);
      });
    });
  });
</script>

</body>
</html>
